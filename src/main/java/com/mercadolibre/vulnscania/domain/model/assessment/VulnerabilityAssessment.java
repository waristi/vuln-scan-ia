package com.mercadolibre.vulnscania.domain.model.assessment;

import com.mercadolibre.vulnscania.domain.exception.AssessmentAlreadyCompletedException;
import com.mercadolibre.vulnscania.domain.model.application.Application;
import com.mercadolibre.vulnscania.domain.model.vulnerability.SeverityScore;
import com.mercadolibre.vulnscania.domain.model.vulnerability.Vulnerability;

import java.time.Instant;
import java.util.Objects;

/**
 * Agregado: VulnerabilityAssessment
 * Representa una evaluación completa de una vulnerabilidad en el contexto de una aplicación específica.
 * Combina información de la vulnerabilidad con el contexto de la aplicación para producir un análisis.
 */
public class VulnerabilityAssessment {
    
    private final AssessmentId id;
    private final Vulnerability vulnerability;
    private final Application application;
    private final Instant startedAt;
    
    private AssessmentStatus status;
    private SeverityScore finalScore;
    private String justification;
    private String aiAnalysis;
    private Double confidenceLevel;
    private Instant completedAt;
    
    // Constructor privado
    private VulnerabilityAssessment(AssessmentId id,
                                   Vulnerability vulnerability,
                                   Application application,
                                   Instant startedAt) {
        this.id = Objects.requireNonNull(id, "Assessment ID is required");
        this.vulnerability = Objects.requireNonNull(vulnerability, "Vulnerability is required");
        this.application = Objects.requireNonNull(application, "Application is required");
        this.startedAt = startedAt != null ? startedAt : Instant.now();
        this.status = AssessmentStatus.IN_PROGRESS;
    }
    
    /**
     * Factory method: Inicia una nueva evaluación.
     */
    public static VulnerabilityAssessment startNew(Vulnerability vulnerability, 
                                                   Application application) {
        return new VulnerabilityAssessment(
            AssessmentId.generate(),
            vulnerability,
            application,
            Instant.now()
        );
    }
    
    /**
     * Factory method: Reconstitución desde persistencia.
     */
    public static VulnerabilityAssessment reconstitute(AssessmentId id,
                                                      Vulnerability vulnerability,
                                                      Application application,
                                                      AssessmentStatus status,
                                                      SeverityScore finalScore,
                                                      String justification,
                                                      String aiAnalysis,
                                                      Double confidenceLevel,
                                                      Instant startedAt,
                                                      Instant completedAt) {
        VulnerabilityAssessment assessment = new VulnerabilityAssessment(
            id, vulnerability, application, startedAt
        );
        assessment.status = status;
        assessment.finalScore = finalScore;
        assessment.justification = justification;
        assessment.aiAnalysis = aiAnalysis;
        assessment.confidenceLevel = confidenceLevel;
        assessment.completedAt = completedAt;
        return assessment;
    }
    
    /**
     * Completa la evaluación con los resultados del análisis.
     * Regla de negocio: Una evaluación completada no puede ser modificada.
     */
    public void complete(SeverityScore finalScore, 
                        String justification, 
                        String aiAnalysis,
                        Double confidenceLevel) {
        
        if (this.status == AssessmentStatus.COMPLETED) {
            throw new AssessmentAlreadyCompletedException(this.id.value());
        }
        
        Objects.requireNonNull(finalScore, "Final score is required");
        Objects.requireNonNull(justification, "Justification is required");
        
        if (confidenceLevel != null && (confidenceLevel < 0.0 || confidenceLevel > 1.0)) {
            throw new IllegalArgumentException("Confidence level must be between 0.0 and 1.0");
        }
        
        this.finalScore = finalScore;
        this.justification = justification;
        this.aiAnalysis = aiAnalysis;
        this.confidenceLevel = confidenceLevel;
        this.status = AssessmentStatus.COMPLETED;
        this.completedAt = Instant.now();
    }
    
    /**
     * Marca la evaluación como fallida.
     */
    public void markAsFailed(String reason) {
        Objects.requireNonNull(reason, "Failure reason is required");
        
        this.status = AssessmentStatus.FAILED;
        this.justification = "Assessment failed: " + reason;
        this.completedAt = Instant.now();
    }
    
    /**
     * Marca la evaluación como requiere revisión manual.
     */
    public void requiresReview(String reason) {
        Objects.requireNonNull(reason, "Review reason is required");
        
        this.status = AssessmentStatus.REQUIRES_REVIEW;
        this.justification = "Requires manual review: " + reason;
    }
    
    /**
     * Calcula el tiempo de evaluación en segundos.
     */
    public Long getEvaluationDurationSeconds() {
        if (completedAt == null) {
            return null;
        }
        return completedAt.getEpochSecond() - startedAt.getEpochSecond();
    }
    
    /**
     * Determina si la evaluación está completa.
     */
    public boolean isCompleted() {
        return this.status == AssessmentStatus.COMPLETED;
    }
    
    /**
     * Determina si la evaluación requiere revisión manual.
     * Regla de negocio: Requiere revisión si la confianza es baja (< 0.7) o está marcada explícitamente.
     */
    public boolean needsManualReview() {
        return this.status == AssessmentStatus.REQUIRES_REVIEW ||
               (confidenceLevel != null && confidenceLevel < 0.7);
    }
    
    /**
     * Obtiene el resumen de la evaluación.
     */
    public String getSummary() {
        if (finalScore == null) {
            return "Assessment in progress";
        }
        
        return String.format(
            "Vulnerability %s on Application %s: Score %.1f (%s)",
            vulnerability.getCveId().value(),
            application.getName(),
            finalScore.value(),
            vulnerability.getSeverityLevel()
        );
    }
    
    // Getters
    public AssessmentId getId() {
        return id;
    }
    
    public Vulnerability getVulnerability() {
        return vulnerability;
    }
    
    public Application getApplication() {
        return application;
    }
    
    public AssessmentStatus getStatus() {
        return status;
    }
    
    public SeverityScore getFinalScore() {
        return finalScore;
    }
    
    public String getJustification() {
        return justification;
    }
    
    public String getAiAnalysis() {
        return aiAnalysis;
    }
    
    public Double getConfidenceLevel() {
        return confidenceLevel;
    }
    
    public Instant getStartedAt() {
        return startedAt;
    }
    
    public Instant getCompletedAt() {
        return completedAt;
    }
}


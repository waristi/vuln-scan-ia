package com.mercadolibre.vulnscania.domain.command;

import com.mercadolibre.vulnscania.domain.model.ai.AIProvider;
import com.mercadolibre.vulnscania.domain.model.application.ApplicationId;
import com.mercadolibre.vulnscania.domain.model.vulnerability.CveId;

import java.util.Objects;

/**
 * Command to evaluate a vulnerability for a specific application.
 * 
 * <p>Immutable record following the Command Pattern.
 * Commands represent user intentions and are used to decouple
 * the API layer from the domain layer.</p>
 * 
 * <p><strong>AI Analysis Configuration</strong>:</p>
 * <ul>
 *   <li>AI analysis is always enabled (mandatory)</li>
 *   <li>If <code>aiProvider</code> is not provided: defaults to "gemini"</li>
 *   <li>If <code>aiProvider</code> is provided: uses the specified provider (openai, claude, gemini)</li>
 *   <li><code>aiModel</code> is optional - if not provided, uses default model for the provider</li>
 * </ul>
 * 
 * @param cveId CVE identifier to evaluate
 * @param applicationId Application that may be affected
 * @param aiProvider AI provider to use for analysis (openai, claude, gemini). Defaults to "gemini" if not provided.
 * @param aiModel Optional specific AI model to use (e.g., "gpt-4-turbo-preview", "gemini-2.5-flash")
 */
public record EvaluateVulnerabilityCommand(
    CveId cveId,
    ApplicationId applicationId,
    String aiProvider,
    String aiModel
) {
    
    public EvaluateVulnerabilityCommand {
        Objects.requireNonNull(cveId, "CVE ID is required");
        Objects.requireNonNull(applicationId, "Application ID is required");
        
        aiProvider = (aiProvider != null && aiProvider.isBlank()) ? null : aiProvider;
        aiModel = (aiModel != null && aiModel.isBlank()) ? null : aiModel;
        
        if (aiProvider == null) {
            aiProvider = AIProvider.DEFAULT;
        }
    }
    
    /**
     * Constructor with default AI provider (gemini).
     * 
     * @param cveId CVE identifier
     * @param applicationId Application identifier
     */
    public EvaluateVulnerabilityCommand(CveId cveId, ApplicationId applicationId) {
        this(cveId, applicationId, AIProvider.DEFAULT, null);
    }
    
    /**
     * Determines if AI analysis should be used.
     * 
     * <p>AI analysis is always enabled (mandatory), so this always returns true.</p>
     * 
     * @return always true (AI analysis is mandatory)
     */
    public boolean useAIAnalysis() {
        return aiProvider != null;
    }
}

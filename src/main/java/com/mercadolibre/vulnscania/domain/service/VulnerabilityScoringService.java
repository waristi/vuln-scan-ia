package com.mercadolibre.vulnscania.domain.service;

import com.mercadolibre.vulnscania.domain.model.application.Application;
import com.mercadolibre.vulnscania.domain.model.vulnerability.SeverityScore;
import com.mercadolibre.vulnscania.domain.model.vulnerability.Vulnerability;

/**
 * Domain Service: VulnerabilityScoringService
 * Encapsula la lógica de negocio para calcular scores contextuales de vulnerabilidades.
 * Esta lógica no pertenece a ninguna entidad específica, pero es un concepto de negocio explícito.
 */
public class VulnerabilityScoringService {
    
    private static final double MAX_CONTEXTUAL_ADJUSTMENT = 2.0;
    private static final double MIN_CONTEXTUAL_FACTOR = 0.8;
    
    /**
     * Calcula el score contextual de una vulnerabilidad considerando el contexto de la aplicación.
     * 
     * Reglas de negocio:
     * - El score contextual nunca puede bajar del 80% del score base
     * - El ajuste contextual máximo es +2.0 puntos
     * - Factores: exposición internet, sensibilidad de datos, entorno, CVE antiguo
     * 
     * @param vulnerability La vulnerabilidad a evaluar
     * @param application La aplicación afectada
     * @return Score contextual ajustado
     */
    public SeverityScore calculateContextualScore(Vulnerability vulnerability, 
                                                   Application application) {
        double baseScore = vulnerability.getBaseScore().value();
        double adjustment = 0.0;
        
        // Factor 1: Exposición a internet (+30%)
        if (application.isInternetExposed()) {
            adjustment += baseScore * 0.3;
        }
        
        // Factor 2: Sensibilidad de datos (variable según nivel)
        double dataSensitivityMultiplier = application.getDataSensitivity().getRiskMultiplier();
        if (dataSensitivityMultiplier > 1.0) {
            adjustment += baseScore * (dataSensitivityMultiplier - 1.0);
        }
        
        // Factor 3: Entorno de producción (+20%)
        if (application.isInProduction()) {
            adjustment += baseScore * 0.2;
        }
        
        // Factor 4: Infraestructura crítica (+30% adicional)
        if (application.isCriticalInfrastructure()) {
            adjustment += baseScore * 0.3;
        }
        
        // Factor 5: CVE muy reciente (+10% - amenaza emergente)
        if (vulnerability.getCveId().isRecent()) {
            adjustment += baseScore * 0.1;
        }
        
        // Factor 6: Mitigaciones conocidas reducen riesgo
        int mitigationsCount = application.getKnownMitigations().size();
        if (mitigationsCount > 0) {
            double reduction = Math.min(0.3, mitigationsCount * 0.1);
            adjustment -= baseScore * reduction;
        }
        
        // Aplicar límites de ajuste
        adjustment = Math.min(adjustment, MAX_CONTEXTUAL_ADJUSTMENT);
        
        // Calcular score final con límite mínimo (no bajar de 80% del base)
        double minAllowedScore = baseScore * MIN_CONTEXTUAL_FACTOR;
        double contextualScore = Math.max(minAllowedScore, baseScore + adjustment);
        
        // Clamp al rango válido
        contextualScore = Math.min(SeverityScore.MAX_SCORE, 
                                   Math.max(SeverityScore.MIN_SCORE, contextualScore));
        
        return new SeverityScore(contextualScore);
    }
    
    /**
     * Determina si una vulnerabilidad requiere acción inmediata basado en contexto.
     * 
     * Reglas de negocio:
     * - Score contextual >= 7.0 AND (expuesto a internet OR producción)
     * - Score contextual >= 9.0 (siempre crítico)
     * - Infraestructura crítica con score >= 6.0
     * 
     * @param vulnerability La vulnerabilidad
     * @param application La aplicación
     * @return true si requiere acción inmediata
     */
    public boolean requiresImmediateAction(Vulnerability vulnerability, 
                                          Application application) {
        SeverityScore contextualScore = calculateContextualScore(vulnerability, application);
        
        // Siempre crítico si score >= 9.0
        if (contextualScore.isCritical()) {
            return true;
        }
        
        // High score con exposición o producción
        if (contextualScore.isHigh() && 
            (application.isInternetExposed() || application.isInProduction())) {
            return true;
        }
        
        // Infraestructura crítica con medium-high score
        if (application.isCriticalInfrastructure() && contextualScore.value() >= 6.0) {
            return true;
        }
        
        return false;
    }
    
    /**
     * Calcula el tiempo objetivo de respuesta en horas basado en severidad y contexto.
     * 
     * Reglas de negocio (SLA de remediación):
     * - Critical (>= 9.0): 4 horas
     * - High (>= 7.0): 24 horas
     * - Medium (>= 4.0): 7 días
     * - Low (< 4.0): 30 días
     * - Se reduce a la mitad si es infraestructura crítica
     * 
     * @param vulnerability La vulnerabilidad
     * @param application La aplicación
     * @return Tiempo objetivo en horas
     */
    public int calculateResponseTimeSLA(Vulnerability vulnerability, 
                                       Application application) {
        SeverityScore contextualScore = calculateContextualScore(vulnerability, application);
        
        int baseHours;
        if (contextualScore.isCritical()) {
            baseHours = 4;
        } else if (contextualScore.isHigh()) {
            baseHours = 24;
        } else if (contextualScore.isMedium()) {
            baseHours = 7 * 24; // 7 días
        } else {
            baseHours = 30 * 24; // 30 días
        }
        
        // Infraestructura crítica reduce SLA a la mitad
        if (application.isCriticalInfrastructure()) {
            baseHours = baseHours / 2;
        }
        
        return Math.max(1, baseHours); // Mínimo 1 hora
    }
}


package com.mercadolibre.vulnscania.application.usecase;

import com.mercadolibre.vulnscania.domain.exception.VulnerabilityNotFoundException;
import com.mercadolibre.vulnscania.domain.model.vulnerability.Vulnerability;
import com.mercadolibre.vulnscania.domain.model.vulnerability.VulnerabilityId;
import com.mercadolibre.vulnscania.domain.port.output.VulnerabilityRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * Use Case: Get Vulnerability Status
 * 
 * Retrieves current status and details of a vulnerability.
 */
@Service
public class GetVulnerabilityStatusUseCase {
    
    private final VulnerabilityRepository vulnerabilityRepository;
    
    public GetVulnerabilityStatusUseCase(VulnerabilityRepository vulnerabilityRepository) {
        this.vulnerabilityRepository = vulnerabilityRepository;
    }
    
    @Transactional(readOnly = true)
    public VulnerabilityStatusResult execute(String vulnerabilityId) {
        Vulnerability vulnerability = vulnerabilityRepository
            .findById(VulnerabilityId.of(vulnerabilityId))
            .orElseThrow(() -> new VulnerabilityNotFoundException(vulnerabilityId));
        
        return VulnerabilityStatusResult.fromDomain(vulnerability);
    }
    
    /**
     * Result DTO for the use case.
     */
    public record VulnerabilityStatusResult(
        String id,
        String cveId,
        String applicationId,
        double baseScore,
        double contextualScore,
        String severityLevel,
        String status,
        String type,
        String description,
        String aiJustification,
        boolean requiresImmediateAction
    ) {
        public static VulnerabilityStatusResult fromDomain(Vulnerability vulnerability) {
            return new VulnerabilityStatusResult(
                vulnerability.getId().value(),
                vulnerability.getCveId().value(),
                vulnerability.getApplicationId().value(),
                vulnerability.getBaseScore().value(),
                vulnerability.getContextualScore().value(),
                vulnerability.getSeverityLevel().name(),
                vulnerability.getStatus().name(),
                vulnerability.getType().name(),
                vulnerability.getDescription(),
                vulnerability.getAiJustification(),
                vulnerability.requiresImmediateAction()
            );
        }
    }
}


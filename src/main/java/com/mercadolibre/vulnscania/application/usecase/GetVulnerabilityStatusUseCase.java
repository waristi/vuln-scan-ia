package com.mercadolibre.vulnscania.application.usecase;

import com.mercadolibre.vulnscania.application.port.input.GetVulnerabilityStatusInputPort;
import com.mercadolibre.vulnscania.domain.exception.VulnerabilityNotFoundException;
import com.mercadolibre.vulnscania.domain.model.vulnerability.Vulnerability;
import com.mercadolibre.vulnscania.domain.model.vulnerability.VulnerabilityId;
import com.mercadolibre.vulnscania.domain.port.output.VulnerabilityRepository;

/**
 * Use Case: Get Vulnerability Status
 * 
 * Retrieves current status and details of a vulnerability.
 * 
 * NOTE: This class is framework-independent. This is a read-only operation,
 * so transaction management can be handled at the infrastructure layer if needed.
 * 
 * <p>This use case implements the GetVulnerabilityStatusInputPort interface,
 * following the Dependency Inversion Principle (SOLID).</p>
 */
public class GetVulnerabilityStatusUseCase implements GetVulnerabilityStatusInputPort {
    
    private final VulnerabilityRepository vulnerabilityRepository;
    
    public GetVulnerabilityStatusUseCase(VulnerabilityRepository vulnerabilityRepository) {
        this.vulnerabilityRepository = vulnerabilityRepository;
    }
    
    /**
     * Executes the get vulnerability status use case.
     * 
     * @param vulnerabilityId the vulnerability ID
     * @return the vulnerability status result
     */
    @Override
    public VulnerabilityStatusResult execute(String vulnerabilityId) {
        Vulnerability vulnerability = vulnerabilityRepository
            .findById(VulnerabilityId.of(vulnerabilityId))
            .orElseThrow(() -> new VulnerabilityNotFoundException(vulnerabilityId));
        
        return VulnerabilityStatusResult.fromDomain(vulnerability);
    }
    
    /**
     * Result DTO for the use case.
     */
    /**
     * DTO for vulnerability status result.
     * 
     * <p>Note: requiresImmediateAction was removed because it requires an Application parameter
     * in the new Rich Domain Model implementation. To get this information, use the
     * EvaluateVulnerabilityUseCase with the full application context.</p>
     */
    public record VulnerabilityStatusResult(
        String id,
        String cveId,
        String applicationId,
        double baseScore,
        double contextualScore,
        String severityLevel,
        String status,
        String type,
        String description,
        String aiJustification
    ) {
        public static VulnerabilityStatusResult fromDomain(Vulnerability vulnerability) {
            return new VulnerabilityStatusResult(
                vulnerability.getId().value(),
                vulnerability.getCveId().value(),
                vulnerability.getApplicationId().value(),
                vulnerability.getBaseScore().value(),
                vulnerability.getContextualScore().value(),
                vulnerability.getSeverityLevel().name(),
                vulnerability.getStatus().name(),
                vulnerability.getType().name(),
                vulnerability.getDescription(),
                vulnerability.getAiJustification()
            );
        }
    }
}


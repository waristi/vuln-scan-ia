package com.mercadolibre.vulnscania.infrastructure.adapter.output.persistence.mongodb.document;

import com.mercadolibre.vulnscania.domain.model.application.ApplicationId;
import com.mercadolibre.vulnscania.domain.model.vulnerability.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.index.CompoundIndex;
import org.springframework.data.mongodb.core.index.Indexed;
import org.springframework.data.mongodb.core.mapping.Document;

import java.time.Instant;

/**
 * MongoDB document for Vulnerability aggregate.
 */
@Document(collection = "vulnerabilities")
@CompoundIndex(name = "cve_app_idx", def = "{'cveId': 1, 'applicationId': 1}", unique = true)
public class VulnerabilityDocument {
    
    @Id
    private String id;
    
    @Indexed
    private String cveId;
    
    @Indexed
    private String applicationId;
    
    private double baseScore;
    private double contextualScore;
    private String cvssVector;
    
    @Indexed
    private String status;
    
    private String type;
    private String description;
    private String aiJustification;
    private Instant detectedAt;
    
    public VulnerabilityDocument() {
    }
    
    /**
     * Converts domain Vulnerability to document.
     */
    public static VulnerabilityDocument fromDomain(Vulnerability vulnerability) {
        VulnerabilityDocument doc = new VulnerabilityDocument();
        doc.id = vulnerability.getId().value();
        doc.cveId = vulnerability.getCveId().value();
        doc.applicationId = vulnerability.getApplicationId().value();
        doc.baseScore = vulnerability.getBaseScore().value();
        doc.contextualScore = vulnerability.getContextualScore().value();
        doc.cvssVector = vulnerability.getCvssVector() != null ? 
            vulnerability.getCvssVector().value() : null;
        doc.status = vulnerability.getStatus().name();
        doc.type = vulnerability.getType().name();
        doc.description = vulnerability.getDescription();
        doc.aiJustification = vulnerability.getAiJustification();
        doc.detectedAt = vulnerability.getDetectedAt();
        return doc;
    }
    
    /**
     * Converts document to domain Vulnerability.
     */
    public Vulnerability toDomain() {
        return Vulnerability.reconstitute(
            VulnerabilityId.of(id),
            new CveId(cveId),
            ApplicationId.of(applicationId),
            new SeverityScore(baseScore),
            new SeverityScore(contextualScore),
            VulnerabilityStatus.valueOf(status),
            detectedAt
        );
    }
    
    public String getId() {
        return id;
    }
    
    public String getCveId() {
        return cveId;
    }
    
    public String getApplicationId() {
        return applicationId;
    }
    
    public String getStatus() {
        return status;
    }
}


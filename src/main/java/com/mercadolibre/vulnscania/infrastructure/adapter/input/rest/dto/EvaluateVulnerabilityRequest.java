package com.mercadolibre.vulnscania.infrastructure.adapter.input.rest.dto;

import com.mercadolibre.vulnscania.domain.model.ai.AIProvider;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;

/**
 * REST API DTO for vulnerability evaluation request.
 * 
 * <p>This record represents the request body for the {@code /api/v1/vulnerabilities/evaluate} endpoint.
 * It contains all information necessary to evaluate a CVE vulnerability in the context of
 * a specific application, including optional AI provider configuration.</p>
 * 
 * <p><strong>AI Analysis Configuration</strong>:</p>
 * <ul>
 *   <li>AI analysis is always enabled (mandatory)</li>
 *   <li>If <code>aiProvider</code> is not provided: defaults to {@link com.mercadolibre.vulnscania.domain.model.ai.AIProvider#DEFAULT}</li>
 *   <li>If <code>aiProvider</code> is provided: uses the specified provider (openai, claude, gemini)</li>
 *   <li><code>aiModel</code> is optional - if not provided, uses default model configured for the provider</li>
 * </ul>
 * 
 * <p><strong>Supported AI Providers</strong>:</p>
 * <ul>
 *   <li>{@code openai} - OpenAI GPT models (e.g., gpt-4-turbo-preview)</li>
 *   <li>{@code claude} - Anthropic Claude models (e.g., claude-3-5-sonnet-20241022)</li>
 *   <li>{@code gemini} - Google Gemini models (e.g., gemini-2.5-flash) - Default</li>
 * </ul>
 * 
 * <p><strong>Validation</strong>:</p>
 * <ul>
 *   <li>CVE ID must match format: {@code CVE-YYYY-NNNNN}</li>
 *   <li>Application ID is required and must be non-blank</li>
 *   <li>AI provider and model are optional (provider defaults to gemini)</li>
 * </ul>
 * 
 * @param cveId CVE identifier in format CVE-YYYY-NNNNN (e.g., CVE-2024-1234). Must not be blank.
 * @param applicationId Unique identifier of the application to evaluate. Must not be blank.
 * @param aiProvider AI provider name (openai, claude, gemini). Optional, defaults to "gemini" if null or blank.
 * @param aiModel Specific AI model name (e.g., "gpt-4-turbo-preview", "gemini-2.5-flash"). Optional, uses provider default if null.
 */
public record EvaluateVulnerabilityRequest(
    
    @NotBlank(message = "CVE ID is required")
    @Pattern(regexp = "^CVE-\\d{4}-\\d{4,}$", message = "Invalid CVE ID format. Expected: CVE-YYYY-NNNNN")
    String cveId,
    
    @NotBlank(message = "Application ID is required")
    String applicationId,
    
    String aiProvider,
    
    String aiModel
) {
    public EvaluateVulnerabilityRequest {
        if (aiProvider != null && aiProvider.isBlank()) {
            aiProvider = null;
        }
        
        if (aiModel != null && aiModel.isBlank()) {
            aiModel = null;
        }
        
        if (aiProvider == null) {
            aiProvider = AIProvider.DEFAULT;
        }
    }
}

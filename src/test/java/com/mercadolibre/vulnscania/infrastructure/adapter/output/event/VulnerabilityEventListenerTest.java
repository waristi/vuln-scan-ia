package com.mercadolibre.vulnscania.infrastructure.adapter.output.event;

import com.mercadolibre.vulnscania.domain.event.*;
import com.mercadolibre.vulnscania.domain.model.application.ApplicationId;
import com.mercadolibre.vulnscania.domain.model.assessment.AssessmentId;
import com.mercadolibre.vulnscania.domain.model.vulnerability.CveId;
import com.mercadolibre.vulnscania.domain.model.vulnerability.SeverityScore;
import com.mercadolibre.vulnscania.domain.model.vulnerability.VulnerabilityId;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.junit.jupiter.MockitoExtension;

import java.time.Instant;

import static org.assertj.core.api.Assertions.*;

@ExtendWith(MockitoExtension.class)
class VulnerabilityEventListenerTest {
    
    @InjectMocks
    private VulnerabilityEventListener listener;
    
    @Test
    void shouldHandleVulnerabilityDetectedEvent() {
        // Given
        VulnerabilityDetectedEvent event = new VulnerabilityDetectedEvent(
            VulnerabilityId.generate(),
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(7.5),
            Instant.now()
        );
        
        // When/Then - Should not throw exception
        assertThatNoException().isThrownBy(() -> 
            listener.handleVulnerabilityDetected(event));
    }
    
    @Test
    void shouldHandleCriticalVulnerabilityEvent() {
        // Given
        VulnerabilityCriticalEvent event = new VulnerabilityCriticalEvent(
            VulnerabilityId.generate(),
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(9.5),
            "Critical score detected",
            Instant.now()
        );
        
        // When/Then
        assertThatNoException().isThrownBy(() -> 
            listener.handleCriticalVulnerability(event));
    }
    
    @Test
    void shouldHandleScoreAdjustedEvent() {
        // Given
        ScoreAdjustedEvent event = new ScoreAdjustedEvent(
            VulnerabilityId.generate(),
            new SeverityScore(7.0),
            new SeverityScore(8.0),
            "AI analysis adjustment",
            Instant.now()
        );
        
        // When/Then
        assertThatNoException().isThrownBy(() -> 
            listener.handleScoreAdjusted(event));
    }
    
    @Test
    void shouldHandleAssessmentCompletedEvent() {
        // Given
        AssessmentCompletedEvent event = new AssessmentCompletedEvent(
            AssessmentId.generate(),
            VulnerabilityId.generate(),
            ApplicationId.of("app-123"),
            new SeverityScore(7.5),
            0.85,
            false,
            Instant.now()
        );
        
        // When/Then
        assertThatNoException().isThrownBy(() -> 
            listener.handleAssessmentCompleted(event));
    }
}


package com.mercadolibre.vulnscania.domain.model.vulnerability;

import com.mercadolibre.vulnscania.domain.exception.InvalidScoreException;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.ValueSource;

import static org.assertj.core.api.Assertions.*;

class SeverityScoreTest {
    
    @ParameterizedTest
    @ValueSource(doubles = {0.0, 5.5, 10.0, 7.5, 4.0})
    void shouldCreateValidSeverityScore(double score) {
        // When
        SeverityScore severityScore = new SeverityScore(score);
        
        // Then
        assertThat(severityScore.value()).isEqualTo(score);
    }
    
    @ParameterizedTest
    @ValueSource(doubles = {-0.1, -5.0, 10.1, 15.0, 100.0})
    void shouldRejectInvalidScores(double invalidScore) {
        // When/Then
        assertThatThrownBy(() -> new SeverityScore(invalidScore))
            .isInstanceOf(InvalidScoreException.class);
    }
    
    @Test
    void shouldIdentifyCriticalScore() {
        // Given
        SeverityScore critical = new SeverityScore(9.0);
        SeverityScore notCritical = new SeverityScore(8.9);
        
        // When/Then
        assertThat(critical.isCritical()).isTrue();
        assertThat(notCritical.isCritical()).isFalse();
    }
    
    @Test
    void shouldIdentifyHighScore() {
        // Given
        SeverityScore high = new SeverityScore(7.0);
        SeverityScore notHigh = new SeverityScore(6.9);
        
        // When/Then
        assertThat(high.isHigh()).isTrue();
        assertThat(notHigh.isHigh()).isFalse();
    }
    
    @Test
    void shouldIdentifyMediumScore() {
        // Given
        SeverityScore medium = new SeverityScore(4.0);
        SeverityScore notMedium = new SeverityScore(3.9);
        
        // When/Then
        assertThat(medium.isMedium()).isTrue();
        assertThat(notMedium.isMedium()).isFalse();
    }
    
    @Test
    void shouldRequireActionForHighScore() {
        // Given
        SeverityScore high = new SeverityScore(7.0);
        SeverityScore low = new SeverityScore(6.9);
        
        // When/Then
        assertThat(high.requiresAction()).isTrue();
        assertThat(low.requiresAction()).isFalse();
    }
    
    @Test
    void shouldIncreaseScoreByFactor() {
        // Given
        SeverityScore score = new SeverityScore(5.0);
        
        // When
        SeverityScore increased = score.increase(1.5);
        
        // Then
        assertThat(increased.value()).isEqualTo(7.5);
    }
    
    @Test
    void shouldNotExceedMaxWhenIncreasing() {
        // Given
        SeverityScore score = new SeverityScore(9.0);
        
        // When
        SeverityScore increased = score.increase(2.0);
        
        // Then
        assertThat(increased.value()).isEqualTo(10.0);
    }
    
    @Test
    void shouldRejectInvalidIncreaseFactor() {
        // Given
        SeverityScore score = new SeverityScore(5.0);
        
        // When/Then
        assertThatThrownBy(() -> score.increase(0.5))
            .isInstanceOf(IllegalArgumentException.class);
    }
    
    @Test
    void shouldReduceScoreByAmount() {
        // Given
        SeverityScore score = new SeverityScore(7.0);
        
        // When
        SeverityScore reduced = score.reduce(2.0);
        
        // Then
        assertThat(reduced.value()).isEqualTo(5.0);
    }
    
    @Test
    void shouldNotGoBelowMinWhenReducing() {
        // Given
        SeverityScore score = new SeverityScore(2.0);
        
        // When
        SeverityScore reduced = score.reduce(5.0);
        
        // Then
        assertThat(reduced.value()).isEqualTo(0.0);
    }
    
    @Test
    void shouldRejectNegativeReduction() {
        // Given
        SeverityScore score = new SeverityScore(5.0);
        
        // When/Then
        assertThatThrownBy(() -> score.reduce(-1.0))
            .isInstanceOf(IllegalArgumentException.class);
    }
    
    @Test
    void shouldAdjustScoreByPositiveDelta() {
        // Given
        SeverityScore score = new SeverityScore(5.0);
        
        // When
        SeverityScore adjusted = score.adjust(2.0);
        
        // Then
        assertThat(adjusted.value()).isEqualTo(7.0);
    }
    
    @Test
    void shouldAdjustScoreByNegativeDelta() {
        // Given
        SeverityScore score = new SeverityScore(7.0);
        
        // When
        SeverityScore adjusted = score.adjust(-2.0);
        
        // Then
        assertThat(adjusted.value()).isEqualTo(5.0);
    }
    
    @Test
    void shouldClampAdjustedScoreToValidRange() {
        // Given
        SeverityScore score = new SeverityScore(5.0);
        
        // When
        SeverityScore adjustedHigh = score.adjust(10.0);
        SeverityScore adjustedLow = score.adjust(-10.0);
        
        // Then
        assertThat(adjustedHigh.value()).isEqualTo(10.0);
        assertThat(adjustedLow.value()).isEqualTo(0.0);
    }
}


package com.mercadolibre.vulnscania.domain.model.vulnerability;

import com.mercadolibre.vulnscania.domain.event.VulnerabilityDetectedEvent;
import com.mercadolibre.vulnscania.domain.exception.InvalidStateTransitionException;
import com.mercadolibre.vulnscania.domain.model.application.Application;
import com.mercadolibre.vulnscania.domain.model.application.ApplicationId;
import com.mercadolibre.vulnscania.domain.model.application.DataSensitivity;
import com.mercadolibre.vulnscania.domain.model.application.Dependency;
import org.junit.jupiter.api.Test;

import java.util.List;

import static org.assertj.core.api.Assertions.*;

class VulnerabilityTest {
    
    @Test
    void shouldCreateNewVulnerability() {
        // Given
        CveId cveId = new CveId("CVE-2024-1234");
        ApplicationId appId = ApplicationId.of("app-123");
        SeverityScore baseScore = new SeverityScore(7.5);
        
        // When
        Vulnerability vulnerability = Vulnerability.create(cveId, appId, baseScore);
        
        // Then
        assertThat(vulnerability).isNotNull();
        assertThat(vulnerability.getCveId()).isEqualTo(cveId);
        assertThat(vulnerability.getApplicationId()).isEqualTo(appId);
        assertThat(vulnerability.getBaseScore()).isEqualTo(baseScore);
            assertThat(vulnerability.getStatus()).isEqualTo(VulnerabilityStatus.PENDING);
    }
    
    @Test
    void shouldEmitDetectedEventOnCreation() {
        // Given
        CveId cveId = new CveId("CVE-2024-1234");
        ApplicationId appId = ApplicationId.of("app-123");
        SeverityScore baseScore = new SeverityScore(7.5);
        
        // When
        Vulnerability vulnerability = Vulnerability.create(cveId, appId, baseScore);
        
        // Then
        assertThat(vulnerability.pullDomainEvents())
            .hasSize(1)
            .first()
            .isInstanceOf(VulnerabilityDetectedEvent.class);
    }
    
    @Test
    void shouldCalculateContextualScoreWithInternetExposure() {
        // Given
        Vulnerability vuln = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(5.0)
        );
        
        Application app = Application.create(
            "Test App",
            List.of("Java"),
            List.of(),
            true,  // internet exposed
              DataSensitivity.CONFIDENTIAL,
            List.of("PRODUCTION")
        );
        
        // When
        SeverityScore contextual = vuln.calculateContextualScore(app);
        
        // Then
        assertThat(contextual.value()).isGreaterThan(5.0);
    }
    
    @Test
    void shouldCalculateContextualScoreWithHighDataSensitivity() {
        // Given
        Vulnerability vuln = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(5.0)
        );
        
        Application app = Application.create(
            "Test App",
            List.of("Java"),
            List.of(),
            false,
            DataSensitivity.HIGHLY_REGULATED,  // high sensitivity
            List.of("DEVELOPMENT")
        );
        
        // When
        SeverityScore contextual = vuln.calculateContextualScore(app);
        
        // Then
        assertThat(contextual.value()).isGreaterThan(5.0);
    }
    
    @Test
    void shouldNotExceedMaxScoreWhenCalculatingContextual() {
        // Given
        Vulnerability vuln = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(9.0)
        );
        
        Application app = Application.create(
            "Test App",
            List.of("Java"),
            List.of(),
            true,  // internet exposed
              DataSensitivity.HIGHLY_REGULATED,  // critical sensitivity
            List.of("PRODUCTION")
        );
        // Critical infrastructure (high risk)
        
        // When
        SeverityScore contextual = vuln.calculateContextualScore(app);
        
        // Then
        assertThat(contextual.value()).isLessThanOrEqualTo(10.0);
    }
    
    @Test
    void shouldNotGoBelowMinimumWhenCalculatingContextual() {
        // Given
        Vulnerability vuln = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(5.0)
        );
        
        Application app = Application.create(
            "Test App",
            List.of("Java"),
            List.of(),
            false,
            DataSensitivity.INTERNAL,
            List.of("DEVELOPMENT")
        );
        // Add many mitigations
        for (int i = 0; i < 10; i++) {
            app.addMitigation("Mitigation " + i);
        }
        
        // When
        SeverityScore contextual = vuln.calculateContextualScore(app);
        
        // Then - should not go below 80% of base score
        assertThat(contextual.value()).isGreaterThanOrEqualTo(4.0);
    }
    
    @Test
    void shouldRequireImmediateActionForCriticalScore() {
        // Given
        Vulnerability vuln = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(9.5)
        );
        
        Application app = Application.create(
            "Test App",
            List.of("Java"),
            List.of(),
            false,
            DataSensitivity.INTERNAL,
            List.of("DEVELOPMENT")
        );
        
        // When
        boolean requiresAction = vuln.requiresImmediateAction(app);
        
        // Then
        assertThat(requiresAction).isTrue();
    }
    
    @Test
    void shouldRequireImmediateActionForHighScoreWithInternetExposure() {
        // Given
        Vulnerability vuln = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(7.0)
        );
        
        Application app = Application.create(
            "Test App",
            List.of("Java"),
            List.of(),
            true,  // internet exposed
            DataSensitivity.INTERNAL,
            List.of("DEVELOPMENT")
        );
        
        // When
        boolean requiresAction = vuln.requiresImmediateAction(app);
        
        // Then
        assertThat(requiresAction).isTrue();
    }
    
    @Test
    void shouldRequireImmediateActionForCriticalInfrastructure() {
        // Given
        Vulnerability vuln = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(6.0)
        );
        
        Application app = Application.create(
            "Test App",
            List.of("Java"),
            List.of(),
            false,
            DataSensitivity.INTERNAL,
            List.of("DEVELOPMENT")
        );
        // Critical infrastructure (high risk)
        
        // When
        boolean requiresAction = vuln.requiresImmediateAction(app);
        
        // Then
        assertThat(requiresAction).isTrue();
    }
    
    @Test
    void shouldNotRequireImmediateActionForLowScore() {
        // Given
        Vulnerability vuln = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(3.0)
        );
        
        Application app = Application.create(
            "Test App",
            List.of("Java"),
            List.of(),
            false,
            DataSensitivity.INTERNAL,
            List.of("DEVELOPMENT")
        );
        
        // When
        boolean requiresAction = vuln.requiresImmediateAction(app);
        
        // Then
        assertThat(requiresAction).isFalse();
    }
    
    @Test
    void shouldCalculateCriticalSLA() {
        // Given
        Vulnerability vuln = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(9.5)
        );
        
        Application app = Application.create(
            "Test App",
            List.of("Java"),
            List.of(),
            false,
            DataSensitivity.INTERNAL,
            List.of("DEVELOPMENT")
        );
        
        // When
        int sla = vuln.calculateResponseTimeSLA(app);
        
        // Then
        assertThat(sla).isEqualTo(4);  // 4 hours for critical
    }
    
    @Test
    void shouldCalculateHighSLA() {
        // Given
        Vulnerability vuln = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(7.5)
        );
        
        Application app = Application.create(
            "Test App",
            List.of("Java"),
            List.of(),
            false,
            DataSensitivity.INTERNAL,
            List.of("DEVELOPMENT")
        );
        
        // When
        int sla = vuln.calculateResponseTimeSLA(app);
        
        // Then
        assertThat(sla).isEqualTo(24);  // 24 hours for high
    }
    
    @Test
    void shouldHalveSLAForCriticalInfrastructure() {
        // Given
        Vulnerability vuln = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(7.5)
        );
        
        Application app = Application.create(
            "Test App",
            List.of("Java"),
            List.of(),
            false,
            DataSensitivity.INTERNAL,
            List.of("DEVELOPMENT")
        );
        // Critical infrastructure (high risk)
        
        // When
        int sla = vuln.calculateResponseTimeSLA(app);
        
        // Then
        assertThat(sla).isEqualTo(12);  // 24 / 2 = 12 hours
    }
    
    @Test
    void shouldMarkAsMitigated() {
        // Given
        Vulnerability vulnerability = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(7.5)
        );
        
        // When
        vulnerability.markAsMitigated("Patched to version 3.2.0");
        
        // Then
        assertThat(vulnerability.getStatus()).isEqualTo(VulnerabilityStatus.MITIGATED);
    }
    
    @Test
    void shouldMarkAsFalsePositive() {
        // Given
        Vulnerability vulnerability = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(7.5)
        );
        
        // When
        vulnerability.markAsFalsePositive("Not actually vulnerable");
        
        // Then
        assertThat(vulnerability.getStatus()).isEqualTo(VulnerabilityStatus.FALSE_POSITIVE);
    }
    
    @Test
    void shouldGetSeverityLevel() {
        // Given
        Vulnerability critical = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(9.5)
        );
        
        // When
        SeverityLevel level = critical.getSeverityLevel();
        
        // Then
        assertThat(level).isEqualTo(SeverityLevel.CRITICAL);
    }
    
    @Test
    void shouldClearEventsAfterPulling() {
        // Given
        Vulnerability vulnerability = Vulnerability.create(
            new CveId("CVE-2024-1234"),
            ApplicationId.of("app-123"),
            new SeverityScore(7.5)
        );
        
        // When
        vulnerability.pullDomainEvents();
        var secondPull = vulnerability.pullDomainEvents();
        
        // Then
        assertThat(secondPull).isEmpty();
    }
}


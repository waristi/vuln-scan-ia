package com.mercadolibre.vulnscania.domain.model.vulnerability;

import com.mercadolibre.vulnscania.domain.exception.InvalidCveIdException;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.ValueSource;

import java.time.LocalDate;

import static org.assertj.core.api.Assertions.*;

class CveIdTest {
    
    @Test
    void shouldCreateValidCveId() {
        // Given
        String validCveId = "CVE-2024-1234";
        
        // When
        CveId cveId = new CveId(validCveId);
        
        // Then
        assertThat(cveId.value()).isEqualTo(validCveId);
    }
    
    @ParameterizedTest
    @ValueSource(strings = {
        "CVE-2024-1234",
        "CVE-2023-12345",
        "CVE-2021-123456789",
        "CVE-1999-0001"
    })
    void shouldAcceptValidCveFormats(String validCve) {
        // When/Then
        assertThatNoException().isThrownBy(() -> new CveId(validCve));
    }
    
    @ParameterizedTest
    @ValueSource(strings = {
        "",
        "   ",
        "invalid",
        "CVE-123-456",       // Year must be 4 digits
        "CVE-2024-123",      // ID must be at least 4 digits
        "CVE2024-1234",      // Missing hyphen
        "cve-2024-1234",     // Must be uppercase
        "2024-1234"          // Missing CVE prefix
    })
    void shouldRejectInvalidCveFormats(String invalidCve) {
        // When/Then
        assertThatThrownBy(() -> new CveId(invalidCve))
            .isInstanceOf(InvalidCveIdException.class);
    }
    
    @Test
    void shouldRejectNullCveId() {
        // When/Then
        assertThatThrownBy(() -> new CveId(null))
            .isInstanceOf(InvalidCveIdException.class);
    }
    
    @Test
    void shouldExtractYearCorrectly() {
        // Given
        CveId cveId = new CveId("CVE-2024-1234");
        
        // When
        int year = cveId.getYear();
        
        // Then
        assertThat(year).isEqualTo(2024);
    }
    
    @Test
    void shouldIdentifyRecentCve() {
        // Given
        int currentYear = LocalDate.now().getYear();
        CveId recentCve = new CveId(String.format("CVE-%d-1234", currentYear));
        
        // When/Then
        assertThat(recentCve.isRecent()).isTrue();
    }
    
    @Test
    void shouldIdentifyOldCve() {
        // Given
        CveId oldCve = new CveId("CVE-2020-1234");
        
        // When/Then
        assertThat(oldCve.isRecent()).isFalse();
    }
    
    @Test
    void shouldCheckYear() {
        // Given
        CveId cveId = new CveId("CVE-2023-1234");
        
        // When/Then
        assertThat(cveId.isFromYear(2023)).isTrue();
        assertThat(cveId.isFromYear(2024)).isFalse();
    }
    
    @Test
    void shouldImplementEqualsCorrectly() {
        // Given
        CveId cve1 = new CveId("CVE-2024-1234");
        CveId cve2 = new CveId("CVE-2024-1234");
        CveId cve3 = new CveId("CVE-2024-5678");
        
        // When/Then
        assertThat(cve1).isEqualTo(cve2);
        assertThat(cve1).isNotEqualTo(cve3);
        assertThat(cve1.hashCode()).isEqualTo(cve2.hashCode());
    }
}

